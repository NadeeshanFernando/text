name: Daily Sprint PR Digest

on:
  schedule:
    - cron: '30 3 * * *'  # Runs at 9:00 AM SLT (03:30 UTC)
  workflow_dispatch:

jobs:
  sprint-pr-report:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack PR Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ðŸ”§ CONFIGURATION
            const owner = "NadeeshanFernando"; // GitHub username or org
            const repos = ["text"];            // Add more repo names as needed
            const sprintLabel = "sprint-47";   // Change per sprint

            let totalPRs = 0;
            let report = "";

            // Helper: calculate hours ago
            const getHoursAgo = (dateStr) => {
              const msDiff = Date.now() - new Date(dateStr).getTime();
              return Math.floor(msDiff / 3600000);
            };

            for (const repo of repos) {
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                per_page: 100,
              });

              const sprintPRs = prs.filter(pr =>
                pr.labels.some(label => label.name === sprintLabel)
              );

              if (sprintPRs.length === 0) continue;

              totalPRs += sprintPRs.length;
              report += `Repository: ${repo}\n`;

              sprintPRs.forEach(pr => {
                const opened = getHoursAgo(pr.created_at);
                const updated = getHoursAgo(pr.updated_at);
                const author = pr.user?.login || "Unknown";
                const status = pr.draft ? "Draft" : "Open";

                report += `â€¢ <${pr.html_url}|PR #${pr.number}> - ${pr.title}\n`;
                report += `  Author        : @${author}\n`;
                report += `  Opened        : ${opened}h ago\n`;
                report += `  Last Updated  : ${updated}h ago\n`;
                report += `  Status        : ${status}\n\n`;
              });

              report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
            }

            const date = new Date().toLocaleString("en-US", {
              timeZone: "Asia/Colombo",
              dateStyle: "long",
              timeStyle: "short"
            });

            if (totalPRs === 0) {
              report = `All PRs for ${sprintLabel} are merged âœ…`;
            } else {
              report =
                `Sprint PR Summary â€“ ${sprintLabel}\n` +
                `Total PRs to merge: ${totalPRs}\n` +
                `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n` +
                report +
                `Report generated: ${date} (SLT)`;
            }

            const webhook = process.env.SLACK_WEBHOOK_URL;

            await fetch(webhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text: report })
            });
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
